(function () {
  function sendConsentToServer(consent) {
    fetch('https://beautyglow.ciss-mame.fr/backend/controllers/saveConsent.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        consent: consent,
        ip: 'auto'
      })
    })
      .then(res => {
        if (!res.ok) throw new Error('Erreur serveur');
        console.log('Consentement envoy√© au serveur');
      })
      .catch(err => {
        console.error('Erreur consentement:', err);
      });
  }

  function activateAnalytics() {
    const script = document.createElement('script');
    script.src = 'https://www.googletagmanager.com/gtag/js?id=G-P7EJEDSK6K';
    script.async = true;
    document.head.appendChild(script);

    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', 'G-P7EJEDSK6K');

    console.log("Google Analytics activ√©.");
  }

  window.addEventListener("load", function () {
    const consent = localStorage.getItem("cookieconsent");

    if (consent === "allow") {
      activateAnalytics();
    }

    if (!consent) {
      const consentBanner = document.createElement("div");
      consentBanner.className = "cookie-consent";
      consentBanner.innerHTML = `
        <div class="cookie-header">üç™ Cookies & vie priv√©e</div>
        <div class="cookie-message">
          Ce site utilise des cookies et vous donne le contr√¥le sur ceux que vous souhaitez activer.
          <a href="/mentions-legales" target="_blank">Politique de confidentialit√©</a>.
        </div>
        <div class="cookie-buttons">
          <button id="acceptCookies">Tout accepter</button>
          <button id="denyCookies">Tout refuser</button>
        </div>
      `;
      document.body.appendChild(consentBanner);

      document.getElementById("acceptCookies").addEventListener("click", function () {
        localStorage.setItem("cookieconsent", "allow");
        document.body.removeChild(consentBanner);
        sendConsentToServer("allow");
        activateAnalytics();
      });

      document.getElementById("denyCookies").addEventListener("click", function () {
        localStorage.setItem("cookieconsent", "deny");
        document.body.removeChild(consentBanner);
        sendConsentToServer("deny");
      });
    }
  });
})();
